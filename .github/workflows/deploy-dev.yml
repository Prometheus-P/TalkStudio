# =============================================================================
# TalkStudio - Development Environment Deployment
# =============================================================================
# Version: 1.0.0
# Owner: @haseongpark
# Created: 2025-12-08
# Updated: 2025-12-08
#
# Description:
#   Automated deployment pipeline for development environment.
#   Deploys automatically on push to develop branch.
#
# Environment:
#   - URL: https://dev.talkstudio.app (example)
#   - Purpose: Integration testing, feature preview
#   - Auto-deploy: Yes (on develop branch push)
#
# Related Documents:
#   - docs/specs/ARCHITECTURE.md
#   - VERSIONING_GUIDE.md
# =============================================================================

name: Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'
        type: boolean
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

# Cancel in-progress deployments for the same branch
concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  ENVIRONMENT: development
  DEPLOY_URL: https://dev.talkstudio.app

jobs:
  # ===========================================================================
  # Pre-deployment Checks
  # ===========================================================================
  pre-check:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      commit_sha: ${{ steps.check.outputs.commit_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for deployable changes
        id: check
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          # Check if any source files changed
          if echo "$CHANGED_FILES" | grep -qE '^(src/|public/|index.html|vite.config|package.json)'; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "::notice::No deployable changes detected, skipping deployment"
          fi

          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Display deployment info
        run: |
          echo "## Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Run Tests (Optional)
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_deploy == 'true' && github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type check
        run: pnpm tsc --noEmit

      - name: Run tests
        run: pnpm test:ci
        env:
          CI: true

  # ===========================================================================
  # Build for Development
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [pre-check, test]
    if: |
      always() &&
      needs.pre-check.outputs.should_deploy == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    outputs:
      build_id: ${{ steps.build-info.outputs.build_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create .env.development
        run: |
          cat > .env.development << EOF
          VITE_APP_ENV=development
          VITE_APP_VERSION=${{ github.sha }}
          VITE_API_URL=https://api-dev.talkstudio.app
          VITE_ENABLE_DEBUG=true
          VITE_ENABLE_ANALYTICS=false
          EOF

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          VITE_APP_ENV: development

      - name: Generate build info
        id: build-info
        run: |
          BUILD_ID="${{ github.run_number }}-$(date +%Y%m%d%H%M%S)"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

          # Create build manifest
          cat > dist/build-info.json << EOF
          {
            "buildId": "$BUILD_ID",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "environment": "development",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "triggeredBy": "${{ github.actor }}"
          }
          EOF

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dev-${{ github.run_number }}
          path: dist/
          retention-days: 7

  # ===========================================================================
  # Deploy to Development
  # ===========================================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [pre-check, build]
    if: needs.build.result == 'success'
    environment:
      name: development
      url: ${{ env.DEPLOY_URL }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-dev-${{ github.run_number }}
          path: dist/

      # ---------------------------------------------------------------------
      # Option 1: Deploy to Vercel
      # ---------------------------------------------------------------------
      - name: Deploy to Vercel
        if: vars.DEPLOY_TARGET == 'vercel'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./dist
          alias-domains: dev.talkstudio.app

      # ---------------------------------------------------------------------
      # Option 2: Deploy to Netlify
      # ---------------------------------------------------------------------
      - name: Deploy to Netlify
        if: vars.DEPLOY_TARGET == 'netlify'
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
          alias: dev
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # ---------------------------------------------------------------------
      # Option 3: Deploy to AWS S3 + CloudFront
      # ---------------------------------------------------------------------
      - name: Configure AWS credentials
        if: vars.DEPLOY_TARGET == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-2' }}

      - name: Deploy to S3
        if: vars.DEPLOY_TARGET == 'aws'
        run: |
          aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET_DEV }} \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "index.html" \
            --exclude "build-info.json"

          # Upload index.html with no-cache
          aws s3 cp dist/index.html s3://${{ secrets.AWS_S3_BUCKET_DEV }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate"

          aws s3 cp dist/build-info.json s3://${{ secrets.AWS_S3_BUCKET_DEV }}/build-info.json \
            --cache-control "no-cache"

      - name: Invalidate CloudFront cache
        if: vars.DEPLOY_TARGET == 'aws'
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.AWS_CLOUDFRONT_DEV_ID }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ env.DEPLOY_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ needs.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-deployment Verification
  # ===========================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.result == 'success'
    steps:
      - name: Wait for deployment propagation
        run: sleep 30

      - name: Health check
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.DEPLOY_URL }})

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::Health check failed with status $HTTP_STATUS"
            exit 1
          fi

          echo "Health check passed with status $HTTP_STATUS"

      - name: Verify build info
        run: |
          BUILD_INFO=$(curl -s ${{ env.DEPLOY_URL }}/build-info.json)

          DEPLOYED_COMMIT=$(echo $BUILD_INFO | jq -r '.commit')

          if [ "$DEPLOYED_COMMIT" != "${{ github.sha }}" ]; then
            echo "::warning::Deployed commit ($DEPLOYED_COMMIT) does not match expected (${{ github.sha }})"
          else
            echo "Build verification passed"
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "## Verification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Development deployment verified successfully." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notification
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always()
    steps:
      - name: Notify Slack on success
        if: needs.deploy.result == 'success' && vars.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "TalkStudio Development Deployment",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*TalkStudio* deployed to *development*\n\n*Commit*: `${{ github.sha }}`\n*Author*: ${{ github.actor }}\n*URL*: ${{ env.DEPLOY_URL }}"
                  }
                }
              ]
            }'

      - name: Notify Slack on failure
        if: needs.deploy.result == 'failure' && vars.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "TalkStudio Development Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*TalkStudio* deployment to *development* failed\n\n*Commit*: `${{ github.sha }}`\n*Author*: ${{ github.actor }}\n*Action*: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }'
