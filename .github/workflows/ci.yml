name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Frontend (Root level - React/Vite)
      - name: Set up Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install Frontend Dependencies
        run: npm ci --legacy-peer-deps

      - name: Run Frontend Lint
        run: npm run lint

      - name: Run Frontend Build
        run: npm run build

      # Backend (FastAPI)
      - name: Set up Python (Backend)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run Backend Lint
        run: |
          cd backend
          pip install ruff
          ruff check app/

      # AI Agent System (if exists)
      - name: Check AI Agent System
        id: check_ai
        run: |
          if [ -d "ai_agent_system" ] && [ -f "ai_agent_system/requirements.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python (AI Agent System)
        if: steps.check_ai.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'ai_agent_system/requirements.txt'

      - name: Install Python Dependencies (AI Agent System)
        if: steps.check_ai.outputs.exists == 'true'
        run: python -m pip install -r ai_agent_system/requirements.txt
